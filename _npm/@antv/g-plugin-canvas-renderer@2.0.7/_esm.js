/**
 * Bundled by jsDelivr using Rollup v2.79.1 and Terser v5.19.2.
 * Original file: /npm/@antv/g-plugin-canvas-renderer@2.0.7/dist/index.esm.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{__extends as t,__assign as e,__spreadArray as r,__read as i}from"../../tslib@2.6.3/_esm.js";import{Shape as n,isPattern as a,AbstractRendererPlugin as o,GradientType as l,ElementEvent as s,AABB as h,CustomEvent as d,CanvasEvent as c,Node as u}from"../g-lite@2.0.6/_esm.js";import{isNil as p,isString as f}from"../util@3.3.7/_esm.js";import{mat4 as m,vec3 as v}from"../../gl-matrix@3.4.3/_esm.js";var g=function(){function t(t){this.canvasRendererPluginOptions=t,this.removedRBushNodeAABBs=[],this.renderQueue=[],this.restoreStack=[],this.clearFullScreenLastFrame=!1,this.clearFullScreen=!1,this.vpMatrix=m.create(),this.dprMatrix=m.create(),this.tmpMat4=m.create(),this.vec3a=v.create(),this.vec3b=v.create(),this.vec3c=v.create(),this.vec3d=v.create()}return t.prototype.apply=function(e,n){var a=this;this.context=e;var o=e.config,l=e.camera,u=e.renderingService,p=e.renderingContext,f=e.rBushRoot,g=e.pathGeneratorFactory;this.rBush=f,this.pathGeneratorFactory=g;var y=e.contextService,x=p.root.ownerDocument.defaultView,b=function(t){var e=t.target.rBushNode;e.aabb&&a.removedRBushNodeAABBs.push(e.aabb)},M=function(t){var e=t.target.rBushNode;e.aabb&&a.removedRBushNodeAABBs.push(e.aabb)};u.hooks.init.tap(t.tag,(function(){x.addEventListener(s.UNMOUNTED,b),x.addEventListener(s.CULLED,M);var t=y.getDPR(),e=o.width,r=o.height,i=y.getContext();a.clearRect(i,0,0,e*t,r*t,o.background)})),u.hooks.destroy.tap(t.tag,(function(){x.removeEventListener(s.UNMOUNTED,b),x.removeEventListener(s.CULLED,M),a.renderQueue=[],a.removedRBushNodeAABBs=[],a.restoreStack=[]})),u.hooks.beginFrame.tap(t.tag,(function(){var t,e=y.getContext(),r=y.getDPR(),i=o.width,n=o.height,l=a.canvasRendererPluginOptions,s=l.dirtyObjectNumThreshold,h=l.dirtyObjectRatioThreshold,d=u.getStats(),c=d.total,p=d.rendered,f=p/c;a.clearFullScreen=a.clearFullScreenLastFrame||!(null===(t=x.context.renderingPlugins[1])||void 0===t?void 0:t.isFirstTimeRenderingFinished)||u.disableDirtyRectangleRendering()||p>s&&f>h,e&&(e.resetTransform?e.resetTransform():e.setTransform(1,0,0,1,0,0),a.clearFullScreen&&a.clearRect(e,0,0,i*r,n*r,o.background))}));var A=function(t,e){t.isVisible()&&!t.isCulled()&&a.renderDisplayObject(t,e,a.context,a.restoreStack,n),(t.sortable.sorted||t.childNodes).forEach((function(t){A(t,e)}))};u.hooks.endFrame.tap(t.tag,(function(){if(0!==p.root.childNodes.length){a.clearFullScreenLastFrame=!1;var t=y.getContext(),e=y.getDPR();if(m.fromScaling(a.dprMatrix,[e,e,1]),m.multiply(a.vpMatrix,a.dprMatrix,l.getOrthoMatrix()),a.clearFullScreen)A(p.root,t);else{var s=a.safeMergeAABB.apply(a,r([a.mergeDirtyAABBs(a.renderQueue)],i(a.removedRBushNodeAABBs.map((function(t){var e=t.minX,r=t.minY,i=t.maxX,n=t.maxY,a=new h;return a.setMinMax([e,r,0],[i,n,0]),a}))),!1));if(a.removedRBushNodeAABBs=[],h.isEmpty(s))return void(a.renderQueue=[]);var u=a.convertAABB2Rect(s),f=u.x,g=u.y,b=u.width,M=u.height,B=v.transformMat4(a.vec3a,[f,g,0],a.vpMatrix),S=v.transformMat4(a.vec3b,[f+b,g,0],a.vpMatrix),w=v.transformMat4(a.vec3c,[f,g+M,0],a.vpMatrix),R=v.transformMat4(a.vec3d,[f+b,g+M,0],a.vpMatrix),O=Math.min(B[0],S[0],R[0],w[0]),T=Math.min(B[1],S[1],R[1],w[1]),C=Math.max(B[0],S[0],R[0],w[0]),N=Math.max(B[1],S[1],R[1],w[1]),E=Math.floor(O),P=Math.floor(T),L=Math.ceil(C-O),k=Math.ceil(N-T);t.save(),a.clearRect(t,E,P,L,k,o.background),t.beginPath(),t.rect(E,P,L,k),t.clip(),t.setTransform(a.vpMatrix[0],a.vpMatrix[1],a.vpMatrix[4],a.vpMatrix[5],a.vpMatrix[12],a.vpMatrix[13]),o.renderer.getConfig().enableDirtyRectangleRenderingDebug&&x.dispatchEvent(new d(c.DIRTY_RECTANGLE,{dirtyRect:{x:E,y:P,width:L,height:k}})),a.searchDirtyObjects(s).sort((function(t,e){return t.sortable.renderOrder-e.sortable.renderOrder})).forEach((function(e){e&&e.isVisible()&&!e.isCulled()&&a.renderDisplayObject(e,t,a.context,a.restoreStack,n)})),t.restore(),a.renderQueue.forEach((function(t){a.saveDirtyAABB(t)})),a.renderQueue=[]}a.restoreStack.forEach((function(){t.restore()})),a.restoreStack=[]}else a.clearFullScreenLastFrame=!0})),u.hooks.render.tap(t.tag,(function(t){a.clearFullScreen||a.renderQueue.push(t)}))},t.prototype.clearRect=function(t,e,r,i,n,a){t.clearRect(e,r,i,n),a&&(t.fillStyle=a,t.fillRect(e,r,i,n))},t.prototype.renderDisplayObject=function(t,e,r,i,a){var o=t.nodeName,l=i[i.length-1];!l||t.compareDocumentPosition(l)&u.DOCUMENT_POSITION_CONTAINS||(e.restore(),i.pop());var s=this.context.styleRendererFactory[o],h=this.pathGeneratorFactory[o],d=t.parsedStyle.clipPath;if(d){this.applyWorldTransform(e,d);var c=this.pathGeneratorFactory[d.nodeName];c&&(e.save(),i.push(t),e.beginPath(),c(e,d.parsedStyle),e.closePath(),e.clip())}s&&(this.applyWorldTransform(e,t),e.save(),this.applyAttributesToContext(e,t)),h&&(e.beginPath(),h(e,t.parsedStyle),t.nodeName!==n.LINE&&t.nodeName!==n.PATH&&t.nodeName!==n.POLYLINE&&e.closePath()),s&&(s.render(e,t.parsedStyle,t,r,this,a),e.restore()),t.renderable.dirty=!1},t.prototype.convertAABB2Rect=function(t){var e=t.getMin(),r=t.getMax(),i=Math.floor(e[0]),n=Math.floor(e[1]);return{x:i,y:n,width:Math.ceil(r[0])-i,height:Math.ceil(r[1])-n}},t.prototype.mergeDirtyAABBs=function(t){var e=new h;return t.forEach((function(t){var r=t.getRenderBounds();e.add(r);var i=t.renderable.dirtyRenderBounds;i&&e.add(i)})),e},t.prototype.searchDirtyObjects=function(t){var e=i(t.getMin(),2),r=e[0],n=e[1],a=i(t.getMax(),2),o=a[0],l=a[1];return this.rBush.search({minX:r,minY:n,maxX:o,maxY:l}).map((function(t){return t.displayObject}))},t.prototype.saveDirtyAABB=function(t){var e=t.renderable;e.dirtyRenderBounds||(e.dirtyRenderBounds=new h);var r=t.getRenderBounds();r&&e.dirtyRenderBounds.update(r.center,r.halfExtents)},t.prototype.applyAttributesToContext=function(t,e){var r=e.parsedStyle,i=r.stroke,n=r.fill,a=r.opacity,o=r.lineDash,l=r.lineDashOffset;o&&t.setLineDash(o),p(l)||(t.lineDashOffset=l),p(a)||(t.globalAlpha*=a),p(i)||Array.isArray(i)||i.isNone||(t.strokeStyle=e.attributes.stroke),p(n)||Array.isArray(n)||n.isNone||(t.fillStyle=e.attributes.fill)},t.prototype.applyWorldTransform=function(t,e,r){r?(m.copy(this.tmpMat4,e.getLocalTransform()),m.multiply(this.tmpMat4,r,this.tmpMat4),m.multiply(this.tmpMat4,this.vpMatrix,this.tmpMat4)):(m.copy(this.tmpMat4,e.getWorldTransform()),m.multiply(this.tmpMat4,this.vpMatrix,this.tmpMat4)),t.setTransform(this.tmpMat4[0],this.tmpMat4[1],this.tmpMat4[4],this.tmpMat4[5],this.tmpMat4[12],this.tmpMat4[13])},t.prototype.safeMergeAABB=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=new h;return t.forEach((function(t){r.add(t)})),r},t.tag="CanvasRenderer",t}(),y=function(){function t(t){this.imagePool=t}return t.prototype.render=function(t,e,r,i,a,o){var l=e.fill,s=e.fillRule,h=e.opacity,d=void 0===h?1:h,c=e.fillOpacity,u=void 0===c?1:c,f=e.stroke,m=e.strokeOpacity,v=void 0===m?1:m,g=e.lineWidth,y=void 0===g?1:g,b=e.lineCap,M=e.lineJoin,S=e.shadowType,w=e.shadowColor,R=e.shadowBlur,O=e.filter,T=e.miterLimit,C=l&&!l.isNone,N=f&&!f.isNone&&y>0,E=0===(null==l?void 0:l.alpha),P=!(!O||!O.length),L=!p(w)&&R>0,k=r.nodeName,D="inner"===S,F=N&&L&&(k===n.PATH||k===n.LINE||k===n.POLYLINE||E||D);C&&(t.globalAlpha=d*u,F||x(r,t,L),A(t,r,l,s,i,a,o,this.imagePool),F||this.clearShadowAndFilter(t,P,L)),N&&(t.globalAlpha=d*v,t.lineWidth=y,p(T)||(t.miterLimit=T),p(b)||(t.lineCap=b),p(M)||(t.lineJoin=M),F&&(D&&(t.globalCompositeOperation="source-atop"),x(r,t,!0),D&&(B(t,r,f,i,a,o,this.imagePool),t.globalCompositeOperation="source-over",this.clearShadowAndFilter(t,P,!0))),B(t,r,f,i,a,o,this.imagePool))},t.prototype.clearShadowAndFilter=function(t,e,r){if(r&&(t.shadowColor="transparent",t.shadowBlur=0),e){var i=t.filter;!p(i)&&i.indexOf("drop-shadow")>-1&&(t.filter=i.replace(/drop-shadow\([^)]*\)/,"").trim()||"none")}},t}();function x(t,e,r){var i=t.parsedStyle,n=i.filter,a=i.shadowColor,o=i.shadowBlur,l=i.shadowOffsetX,s=i.shadowOffsetY;n&&n.length&&(e.filter=t.style.filter),r&&(e.shadowColor=a.toString(),e.shadowBlur=o||0,e.shadowOffsetX=l||0,e.shadowOffsetY=s||0)}function b(t,e,r,i,n,a,o){var l,s;if("rect"===t.image.nodeName){var h=t.image.parsedStyle,d=h.width,c=h.height;s=i.contextService.getDPR();var u=i.config.offscreenCanvas;(l=a.offscreenCanvasCreator.getOrCreateCanvas(u)).width=d*s,l.height=c*s;var p=a.offscreenCanvasCreator.getOrCreateContext(u),f=[];t.image.forEach((function(t){n.renderDisplayObject(t,p,i,f,a)})),f.forEach((function(){p.restore()}))}return o.getOrCreatePatternSync(t,r,l,s,e.getGeometryBounds().min,(function(){e.renderable.dirty=!0,i.renderingService.dirtify()}))}function M(t,r,i,n){var a;if(t.type===l.LinearGradient||t.type===l.RadialGradient){var o=r.getGeometryBounds(),s=o&&2*o.halfExtents[0]||1,h=o&&2*o.halfExtents[1]||1,d=o&&o.min||[0,0];a=n.getOrCreateGradient(e(e({type:t.type},t.value),{min:d,width:s,height:h}),i)}return a}function A(t,e,r,i,n,o,l,s,h){void 0===h&&(h=!1),Array.isArray(r)?r.forEach((function(r){t.fillStyle=M(r,e,t,s),h||(i?t.fill(i):t.fill())})):(a(r)&&(t.fillStyle=b(r,e,t,n,o,l,s)),h||(i?t.fill(i):t.fill()))}function B(t,e,r,i,n,o,l,s){void 0===s&&(s=!1),Array.isArray(r)?r.forEach((function(r){t.strokeStyle=M(r,e,t,l),s||t.stroke()})):(a(r)&&(t.strokeStyle=b(r,e,t,i,n,o,l)),s||t.stroke())}var S=function(){function t(t){this.imagePool=t}return t.prototype.render=function(t,e,r){var i,n=e.x,a=void 0===n?0:n,o=e.y,l=void 0===o?0:o,s=e.width,h=e.height,d=e.src,c=e.shadowColor,u=e.shadowBlur,m=s,v=h;if(f(d)?i=this.imagePool.getImageSync(d):(m||(m=d.width),v||(v=d.height),i=d),i){x(r,t,!p(c)&&u>0);try{t.drawImage(i,a,l,m,v)}catch(t){}}},t}(),w=function(){function t(t){this.imagePool=t}return t.prototype.render=function(t,e,r,i,n,a){r.getBounds();var o=e,l=o.lineWidth,s=void 0===l?1:l,h=o.textAlign,d=void 0===h?"start":h,c=o.textBaseline,u=void 0===c?"alphabetic":c,f=o.lineJoin,m=void 0===f?"miter":f,v=o.miterLimit,g=void 0===v?10:v,y=o.letterSpacing,b=void 0===y?0:y,M=o.stroke,A=o.fill,B=o.fillRule,S=o.fillOpacity,w=void 0===S?1:S,R=o.strokeOpacity,O=void 0===R?1:R,T=o.opacity,C=void 0===T?1:T,N=o.metrics,E=o.x,P=void 0===E?0:E,L=o.y,k=void 0===L?0:L,D=o.dx,F=o.dy,I=o.shadowColor,G=o.shadowBlur,j=N.font,Y=N.lines,U=N.height,W=N.lineHeight,Q=N.lineMetrics;t.font=j,t.lineWidth=s,t.textAlign="middle"===d?"center":d;var X=u;a.enableCSSParsing||"alphabetic"!==X||(X="bottom"),t.lineJoin=m,p(g)||(t.miterLimit=g);var H=k;"middle"===u?H+=-U/2-W/2:"bottom"===u||"alphabetic"===u||"ideographic"===u?H+=-U:"top"!==u&&"hanging"!==u||(H+=-W);var J=P+(D||0);H+=F||0,1===Y.length&&("bottom"===X?(X="middle",H-=.5*U):"top"===X&&(X="middle",H+=.5*U)),t.textBaseline=X,x(r,t,!p(I)&&G>0);for(var V=0;V<Y.length;V++){var _=s/2+J;H+=W,p(M)||M.isNone||!s||this.drawLetterSpacing(t,r,Y[V],Q[V],d,_,H,b,A,B,w,M,O,C,!0,i,n,a),p(A)||this.drawLetterSpacing(t,r,Y[V],Q[V],d,_,H,b,A,B,w,M,O,C,!1,i,n,a)}},t.prototype.drawLetterSpacing=function(t,e,r,i,n,a,o,l,s,h,d,c,u,p,f,m,v,g){if(0!==l){var y=t.textAlign;t.textAlign="left";var x=a;"center"===n||"middle"===n?x=a-i.width/2:"right"!==n&&"end"!==n||(x=a-i.width);for(var b=Array.from(r),M=t.measureText(r).width,A=0,B=0;B<b.length;++B){var S=b[B];f?this.strokeText(t,e,S,x,o,c,u,m,v,g):this.fillText(t,e,S,x,o,s,h,d,p,m,v,g),x+=M-(A=t.measureText(r.substring(B+1)).width)+l,M=A}t.textAlign=y}else f?this.strokeText(t,e,r,a,o,c,u,m,v,g):this.fillText(t,e,r,a,o,s,h,d,p,m,v,g)},t.prototype.fillText=function(t,e,r,i,n,a,o,l,s,h,d,c){var u;A(t,e,a,o,h,d,c,this.imagePool,!0);var f=!p(l)&&1!==l;f&&(u=t.globalAlpha,t.globalAlpha=l*s),t.fillText(r,i,n),f&&(t.globalAlpha=u)},t.prototype.strokeText=function(t,e,r,i,n,a,o,l,s,h){var d;B(t,e,a,l,s,h,this.imagePool,!0);var c=!p(o)&&1!==o;c&&(d=t.globalAlpha,t.globalAlpha=o),t.strokeText(r,i,n),c&&(t.globalAlpha=d)},t}(),R=function(e){function r(){return null!==e&&e.apply(this,arguments)||this}return t(r,e),r}(y),O=function(e){function r(){return null!==e&&e.apply(this,arguments)||this}return t(r,e),r}(y),T=function(e){function r(){return null!==e&&e.apply(this,arguments)||this}return t(r,e),r}(y),C=function(e){function r(){return null!==e&&e.apply(this,arguments)||this}return t(r,e),r}(y),N=function(e){function r(){return null!==e&&e.apply(this,arguments)||this}return t(r,e),r}(y),E=function(e){function r(){return null!==e&&e.apply(this,arguments)||this}return t(r,e),r}(y),P=function(e){function r(){return null!==e&&e.apply(this,arguments)||this}return t(r,e),r}(y),L=function(r){function i(t){void 0===t&&(t={});var e=r.call(this)||this;return e.options=t,e.name="canvas-renderer",e}return t(i,r),i.prototype.init=function(){var t,r=e({dirtyObjectNumThreshold:500,dirtyObjectRatioThreshold:.8},this.options),i=this.context.imagePool,a=new y(i),o=((t={})[n.CIRCLE]=a,t[n.ELLIPSE]=a,t[n.RECT]=a,t[n.IMAGE]=new S(i),t[n.TEXT]=new w(i),t[n.LINE]=a,t[n.POLYLINE]=a,t[n.POLYGON]=a,t[n.PATH]=a,t[n.GROUP]=void 0,t[n.HTML]=void 0,t[n.MESH]=void 0,t);this.context.defaultStyleRendererFactory=o,this.context.styleRendererFactory=o,this.addRenderingPlugin(new g(r))},i.prototype.destroy=function(){this.removeAllRenderingPlugins(),delete this.context.defaultStyleRendererFactory,delete this.context.styleRendererFactory},i}(o);export{O as CircleRenderer,T as EllipseRenderer,S as ImageRenderer,C as LineRenderer,P as PathRenderer,L as Plugin,E as PolygonRenderer,N as PolylineRenderer,R as RectRenderer,w as TextRenderer};export default null;
